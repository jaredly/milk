# Cross-platform set of build steps for building esy projects

steps:
  - script: npm install -g esy@0.5.6
    displayName: 'npm install -g esy@0.5.6'
  - script: esy install
    displayName: 'esy install'
  - script: esy build
    displayName: 'esy build'
  # Run tests or any additional steps here
  # - script: esy b dune runtest
  - bash: mkdir -p milk-release
  - bash: cp _build/default/bin/Main.exe milk-release/milk.exe
  - bash: chmod +x milk-release/milk.exe
  - bash: zip -r milk-release-$(Agent.OS)-$(Build.SourceVersion).zip milk-release
    condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))

  - task: PublishBuildArtifacts@1
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
    displayName: 'Upload windows binary'
    inputs:
        pathToPublish: 'milk-release'
        artifactName: 'milk-$(Agent.OS)-$(Build.SourceVersion)'
        parallel: true
        parallelCount: 8

  - task: PublishBuildArtifacts@1
    condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))
    displayName: 'Upload binary'
    inputs:
        pathToPublish: 'milk-release-$(Agent.OS)-$(Build.SourceVersion).zip'
        artifactName: 'milk-$(Agent.OS)-$(Build.SourceVersion)'
        parallel: true
        parallelCount: 8
